<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>IndexedDB 파일 저장/삭제 데모</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1220;
      --panel: #171a2b;
      --text: #e7eaf6;
      --muted: #aab3d0;
      --primary: #7aa2ff;
      --accent: #5eead4;
      --danger: #ff6b7a;
      --warn: #ffcc66;
      --border: #273052;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI,
      Roboto, Noto Sans, Apple SD Gothic Neo, Malgun Gothic, sans-serif;
      background: linear-gradient(180deg, #0d1020, #0b1024);
      color: var(--text);
    }
    header {
      padding: 24px 16px; border-bottom: 1px solid var(--border);
      background: rgba(23,26,43,0.6); backdrop-filter: blur(6px);
      position: sticky; top: 0; z-index: 10;
    }
    h1 { margin: 0 0 6px; font-size: 20px; }
    p.desc { margin: 0; color: var(--muted); font-size: 13px; }
    main { max-width: 980px; margin: 24px auto; padding: 0 16px 48px; }

    .panel {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 12px; padding: 16px; margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .grow { flex: 1 1 240px; }
    input[type="file"] {
      background: #0d1124; color: var(--text); border: 1px dashed var(--border);
      padding: 10px; border-radius: 8px; width: 100%;
    }
    input[type="text"], select {
      background: #0d1124; color: var(--text); border: 1px solid var(--border);
      padding: 10px 12px; border-radius: 8px; width: 100%;
    }
    button {
      background: #182449; color: var(--text); border: 1px solid var(--border);
      padding: 10px 14px; border-radius: 10px; cursor: pointer;
      transition: transform 0.05s ease, background 0.2s ease, border 0.2s ease;
    }
    button:hover { background: #1d2b5b; }
    button:active { transform: translateY(1px); }
    button.primary { background: #1c2d68; border-color: #2b3f8f; color: #e9f0ff; }
    button.primary:hover { background: #21407f; }
    button.accent { background: #134e4a; border-color: #186862; color: #e7fffb; }
    button.accent:hover { background: #11635c; }
    button.danger { background: #5a1e2a; border-color: #8a2e3f; color: #ffeef1; }
    button.danger:hover { background: #712433; }
    button.ghost { background: transparent; border-color: var(--border); }

    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .badge {
      display: inline-block; padding: 4px 8px; border: 1px solid var(--border);
      border-radius: 999px; color: var(--muted); font-size: 12px;
      background: #0d1124;
    }

    table {
      width: 100%; border-collapse: collapse; overflow: hidden;
      border-radius: 12px; border: 1px solid var(--border);
      background: #0d1124;
    }
    thead th {
      text-align: left; font-weight: 600; color: var(--muted);
      border-bottom: 1px solid var(--border); padding: 10px;
      background: #0f1530;
    }
    tbody td {
      border-bottom: 1px solid var(--border); padding: 10px; vertical-align: middle;
    }
    tbody tr:hover { background: rgba(122,162,255,0.05); }
    .right { text-align: right; }
    .muted { color: var(--muted); }
    .empty {
      text-align: center; padding: 28px; color: var(--muted);
      border: 1px dashed var(--border); border-radius: 12px; background: #0b0f22;
    }
    footer { color: var(--muted); font-size: 12px; text-align: center; margin-top: 24px; }
  </style>
</head>
<body>
  <header>
    <h1>IndexedDB 파일 저장소</h1>
    <p class="desc">파일을 브라우저 로컬에 안전하게 저장하고, 목록/다운로드/삭제/전체 삭제까지 한 번에.</p>
  </header>

  <main>
    <!-- 업로드 패널 -->
    <section class="panel">
      <div class="row">
        <div class="grow">
          <input id="fileInput" type="file" multiple />
        </div>
        <button id="btnSave" class="primary">선택 파일 저장</button>
        <button id="btnClear" class="danger">전체 삭제</button>
        <span class="badge" id="quotaInfo">-</span>
      </div>
    </section>

    <!-- 필터/정렬 패널 -->
    <section class="panel">
      <div class="toolbar">
        <div class="grow">
          <input id="searchInput" type="text" placeholder="이름으로 검색..." />
        </div>
        <select id="sortSelect" class="grow">
          <option value="createdAt_desc">최신 순</option>
          <option value="createdAt_asc">오래된 순</option>
          <option value="size_desc">크기 큰 순</option>
          <option value="size_asc">크기 작은 순</option>
          <option value="name_asc">이름 A→Z</option>
          <option value="name_desc">이름 Z→A</option>
        </select>
        <button id="btnRefresh" class="ghost">새로고침</button>
      </div>
    </section>

    <!-- 목록 패널 -->
    <section class="panel">
      <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
        <div class="muted">저장된 항목: <span id="count">0</span>개</div>
        <div class="muted">선택: <span id="selectedCount">0</span>개</div>
      </div>

      <div id="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width: 36px;"><input id="checkAll" type="checkbox" /></th>
              <th>이름</th>
              <th>타입</th>
              <th class="right">크기</th>
              <th>저장 시각</th>
              <th class="right">동작</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- 항목 렌더링 -->
          </tbody>
        </table>
        <div id="empty" class="empty" style="display:none;">저장된 파일이 없습니다.</div>
      </div>

      <div class="row" style="margin-top: 12px; justify-content: space-between;">
        <div class="toolbar">
          <button id="btnDeleteSelected" class="danger">선택 삭제</button>
          <button id="btnExportMeta" class="accent">메타데이터 내보내기(JSON)</button>
          <button id="btnImportMeta" class="ghost">메타데이터 가져오기(JSON)</button>
          <input id="importMetaInput" type="file" accept="application/json" style="display:none;" />
        </div>
        <div class="toolbar">
          <button id="btnRecount" class="ghost">용량/갯수 재계산</button>
        </div>
      </div>
    </section>

    <footer>
      IndexedDB 데모 — 로컬에서만 동작합니다. 브라우저/시크릿 모드 정책에 따라 저장 한도가 다를 수 있어요.
    </footer>
  </main>

  <script>
    // -------- 설정 상수 --------
    const DB_NAME = 'fileVaultDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'files';
    // 레코드 스키마: { id: auto, name, type, size, createdAt, blob }

    // -------- 유틸 --------
    const $ = (sel) => document.querySelector(sel);
    const formatBytes = (bytes) => {
      if (bytes === 0) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(i ? 2 : 0) + ' ' + units[i];
    };
    const formatDate = (ms) => {
      const d = new Date(ms);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
    };

    // -------- IndexedDB 핸들 --------
    let db;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            store.createIndex('name', 'name', { unique: false });
            store.createIndex('createdAt', 'createdAt', { unique: false });
            store.createIndex('size', 'size', { unique: false });
          }
        };
        req.onsuccess = (e) => { db = e.target.result; resolve(db); };
        req.onerror = (e) => reject(e.target.error);
      });
    }

    function tx(storeName, mode = 'readonly') {
      return db.transaction(storeName, mode).objectStore(storeName);
    }

    async function addFiles(files) {
      if (!files || !files.length) return 0;
      const store = tx(STORE_NAME, 'readwrite');
      let count = 0;
      for (const file of files) {
        const record = {
          name: file.name,
          type: file.type || 'application/octet-stream',
          size: file.size,
          createdAt: Date.now(),
          blob: file
        };
        await reqAsPromise(store.add(record));
        count++;
      }
      return count;
    }

    function reqAsPromise(request) {
      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function getAll() {
      const store = tx(STORE_NAME, 'readonly');
      if (store.getAll) {
        return await reqAsPromise(store.getAll());
      }
      // fallback: 커서 순회
      return new Promise((resolve, reject) => {
        const out = [];
        const req = store.openCursor();
        req.onsuccess = (e) => {
          const cursor = e.target.result;
          if (cursor) {
            out.push(cursor.value);
            cursor.continue();
          } else {
            resolve(out);
          }
        };
        req.onerror = () => reject(req.error);
      });
    }

    async function deleteById(id) {
      const store = tx(STORE_NAME, 'readwrite');
      await reqAsPromise(store.delete(id));
    }

    async function clearAll() {
      const store = tx(STORE_NAME, 'readwrite');
      await reqAsPromise(store.clear());
    }

    async function getById(id) {
      const store = tx(STORE_NAME, 'readonly');
      return await reqAsPromise(store.get(id));
    }

    // -------- 렌더링 --------
    let cache = [];
    let selected = new Set();

    function render() {
      const tbody = $('#tbody');
      tbody.innerHTML = '';
      const empty = $('#empty');

      const q = $('#searchInput').value.trim().toLowerCase();
      const sort = $('#sortSelect').value;

      let rows = cache.filter(r => !q || (r.name || '').toLowerCase().includes(q));

      const compare = {
        'createdAt_desc': (a,b) => b.createdAt - a.createdAt,
        'createdAt_asc': (a,b) => a.createdAt - b.createdAt,
        'size_desc': (a,b) => b.size - a.size,
        'size_asc': (a,b) => a.size - b.size,
        'name_asc': (a,b) => (a.name||'').localeCompare(b.name||''),
        'name_desc': (a,b) => (b.name||'').localeCompare(a.name||''),
      }[sort] || ((a,b)=>0);

      rows.sort(compare);

      $('#count').textContent = cache.length.toString();
      $('#selectedCount').textContent = selected.size.toString();

      if (!rows.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement('tr');

        const tdSel = document.createElement('td');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = selected.has(r.id);
        chk.addEventListener('change', () => {
          if (chk.checked) selected.add(r.id);
          else selected.delete(r.id);
          $('#selectedCount').textContent = selected.size.toString();
          updateCheckAll();
        });
        tdSel.appendChild(chk);
        tr.appendChild(tdSel);

        const tdName = document.createElement('td');
        tdName.textContent = r.name || '(이름 없음)';
        tr.appendChild(tdName);

        const tdType = document.createElement('td');
        tdType.textContent = r.type || 'application/octet-stream';
        tr.appendChild(tdType);

        const tdSize = document.createElement('td');
        tdSize.className = 'right';
        tdSize.textContent = formatBytes(r.size || 0);
        tr.appendChild(tdSize);

        const tdDate = document.createElement('td');
        tdDate.textContent = formatDate(r.createdAt);
        tr.appendChild(tdDate);

        const tdAct = document.createElement('td');
        tdAct.className = 'right';
        const btnDl = document.createElement('button');
        btnDl.className = 'accent';
        btnDl.textContent = '다운로드';
        btnDl.addEventListener('click', () => downloadRecord(r.id));
        const btnDel = document.createElement('button');
        btnDel.className = 'danger';
        btnDel.style.marginLeft = '8px';
        btnDel.textContent = '삭제';
        btnDel.addEventListener('click', async () => {
          if (!confirm('이 항목을 삭제할까요?')) return;
          await deleteById(r.id);
          selected.delete(r.id);
          await reload();
        });
        tdAct.appendChild(btnDl);
        tdAct.appendChild(btnDel);
        tr.appendChild(tdAct);

        frag.appendChild(tr);
      }
      tbody.appendChild(frag);

      updateCheckAll();
    }

    function updateCheckAll() {
      const allIds = cache.map(r => r.id);
      const checkedCount = allIds.filter(id => selected.has(id)).length;
      const checkAll = $('#checkAll');
      checkAll.indeterminate = checkedCount > 0 && checkedCount < allIds.length;
      checkAll.checked = checkedCount > 0 && checkedCount === allIds.length;
    }

    async function reload() {
      cache = await getAll();
      render();
      await recount();
    }

    // -------- 동작 --------
    async function handleSave() {
      const input = $('#fileInput');
      const files = Array.from(input.files || []);
      if (!files.length) {
        alert('저장할 파일을 선택해 주세요.');
        return;
      }
      try {
        const saved = await addFiles(files);
        input.value = '';
        await reload();
        alert(`${saved}개 파일을 저장했습니다.`);
      } catch (err) {
        console.error(err);
        alert('저장 중 오류가 발생했습니다. 용량 제한 또는 브라우저 정책을 확인해 주세요.');
      }
    }

    async function handleClearAll() {
      if (!cache.length) {
        alert('삭제할 항목이 없습니다.');
        return;
      }
      if (!confirm('정말 전체 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
      await clearAll();
      selected.clear();
      await reload();
      alert('모든 항목을 삭제했습니다.');
    }

    async function handleDeleteSelected() {
      if (!selected.size) {
        alert('선택된 항목이 없습니다.');
        return;
      }
      if (!confirm(`선택한 ${selected.size}개 항목을 삭제할까요?`)) return;
      const store = tx(STORE_NAME, 'readwrite');
      await Promise.all(Array.from(selected).map(id => reqAsPromise(store.delete(id))));
      selected.clear();
      await reload();
      alert('선택 항목을 삭제했습니다.');
    }

    async function downloadRecord(id) {
      try {
        const rec = await getById(id);
        if (!rec) return alert('항목을 찾을 수 없습니다.');
        const url = URL.createObjectURL(rec.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = rec.name || 'download';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e);
        alert('다운로드 중 오류가 발생했습니다.');
      }
    }

    async function recount() {
      const total = cache.reduce((sum, r) => sum + (r.size || 0), 0);
      $('#quotaInfo').textContent = `총 ${cache.length}개 / ${formatBytes(total)}`;
    }

    // 메타데이터 내보내기(Blob 제외) — 백업용
    function exportMeta() {
      const meta = cache.map(({id, name, type, size, createdAt}) => ({id, name, type, size, createdAt}));
      const blob = new Blob([JSON.stringify({ exportedAt: Date.now(), items: meta }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'file-vault-meta.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function importMeta(file) {
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!parsed || !Array.isArray(parsed.items)) {
          alert('올바르지 않은 메타데이터 파일입니다.');
          return;
        }
        // 메타데이터는 참조용이라 DB에 쓰지 않고 콘솔에만 표시
        console.table(parsed.items);
        alert(`메타데이터 ${parsed.items.length}개 항목을 불러왔습니다. (데이터는 쓰지 않습니다)`);
      } catch (e) {
        console.error(e);
        alert('메타데이터 가져오기 중 오류가 발생했습니다.');
      }
    }

    // -------- 이벤트 바인딩 --------
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await openDB();
        await reload();
      } catch (e) {
        console.error(e);
        alert('IndexedDB를 초기화할 수 없습니다. 브라우저 설정을 확인해 주세요.');
      }

      $('#btnSave').addEventListener('click', handleSave);
      $('#btnClear').addEventListener('click', handleClearAll);
      $('#btnDeleteSelected').addEventListener('click', handleDeleteSelected);
      $('#btnRefresh').addEventListener('click', reload);
      $('#btnRecount').addEventListener('click', recount);
      $('#btnExportMeta').addEventListener('click', exportMeta);
      $('#btnImportMeta').addEventListener('click', () => $('#importMetaInput').click());
      $('#importMetaInput').addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) importMeta(f);
        e.target.value = '';
      });

      $('#searchInput').addEventListener('input', render);
      $('#sortSelect').addEventListener('change', render);
      $('#checkAll').addEventListener('change', (e) => {
        if (e.target.checked) {
          cache.forEach(r => selected.add(r.id));
        } else {
          selected.clear();
        }
        render();
      });
    });
  </script>
</body>
</html>
